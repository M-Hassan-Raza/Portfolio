<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Polaris ERP | Muhammad Hassan Raza</title><meta name=keywords content="Django,Vue.js,PostgreSQL,ERP,Full-Stack,Concurrency"><meta name=description content="Full-stack retail ERP system with race-condition-safe inventory, double-entry bookkeeping, and multi-tenant architecture"><meta name=author content="Muhammad Hassan Raza"><link rel=canonical href=https://mhassan.dev/projects/polaris/><link crossorigin=anonymous href=/assets/css/stylesheet.f65ec710c0f335abff38c2a96404121cafed60b7ceca6e1e2b912d76fe864e5b.css integrity="sha256-9l7HEMDzNav/OMKpZAQSHK/tYLfOym4eK5Etdv6GTls=" rel="preload stylesheet" as=style><link rel=icon href=https://mhassan.dev/assets/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://mhassan.dev/assets/favicon.svg><link rel=icon type=image/png sizes=32x32 href=https://mhassan.dev/assets/favicon.svg><link rel=apple-touch-icon href=https://mhassan.dev/apple-touch-icon.png><link rel=mask-icon href=https://mhassan.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://mhassan.dev/projects/polaris/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=preload href=/css/extended/extended.css as=style><link rel=stylesheet href=/css/extended/extended.css><link rel=preload href=/fonts/font-family.css as=style><link rel=stylesheet href=/fonts/font-family.css><link rel=preload href=/fonts/Manrope-Regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/Manrope-Medium.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/Manrope-Bold.woff2 as=font type=font/woff2 crossorigin><script async src=https://cloud.umami.is/script.js data-website-id=30c7d9d6-abac-4c52-b85a-c0234f863d22></script><script async src="https://www.googletagmanager.com/gtag/js?id=%7b%7d"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","{}")</script><meta property="og:url" content="https://mhassan.dev/projects/polaris/"><meta property="og:site_name" content="Muhammad Hassan Raza"><meta property="og:title" content="Polaris ERP"><meta property="og:description" content="Full-stack retail ERP system with race-condition-safe inventory, double-entry bookkeeping, and multi-tenant architecture"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="projects"><meta property="article:published_time" content="2025-02-10T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-10T00:00:00+00:00"><meta property="article:tag" content="Django"><meta property="article:tag" content="Vue.js"><meta property="article:tag" content="PostgreSQL"><meta property="article:tag" content="ERP"><meta property="article:tag" content="Full-Stack"><meta property="article:tag" content="Concurrency"><meta name=twitter:card content="summary"><meta name=twitter:title content="Polaris ERP"><meta name=twitter:description content="Full-stack retail ERP system with race-condition-safe inventory, double-entry bookkeeping, and multi-tenant architecture"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Projects","item":"https://mhassan.dev/projects/"},{"@type":"ListItem","position":2,"name":"Polaris ERP","item":"https://mhassan.dev/projects/polaris/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Polaris ERP","name":"Polaris ERP","description":"Full-stack retail ERP system with race-condition-safe inventory, double-entry bookkeeping, and multi-tenant architecture","keywords":["Django","Vue.js","PostgreSQL","ERP","Full-Stack","Concurrency"],"articleBody":"Polaris is a full-stack ERP and POS system I built for retail businesses. It handles inventory, sales, customer management, and financial reporting—the kind of system where bugs cost money and downtime loses customers.\nTech Stack: Vue 3, Pinia, TanStack Query, Django, Django REST Framework, PostgreSQL, WeasyPrint\nSource: Private (client work) · Book a call to discuss\nThe Hard Problems Building ERP software sounds straightforward until you hit the edge cases that make or break real businesses:\nConcurrent inventory access — Two cashiers selling the last item at the same time. Two stock clerks adjusting quantities. A sale happening while someone generates a report.\nFinancial integrity — Customer balances that must always reconcile. Partial payments, returns, credit notes, and adjustments that all need to balance correctly.\nMulti-tenant data isolation — Multiple organizations sharing infrastructure where one tenant must never see another’s data—not through bugs, not through clever URL manipulation, not through anything.\nBatch costing — Products arrive in batches at different prices. When you sell, which cost do you use? FIFO costing with full supplier traceability.\nTechnical Deep Dives Race Condition Prevention: Dual-Layer Locking The inventory system uses a dual-layer locking strategy to prevent race conditions without sacrificing performance.\nLayer 1: Pessimistic Locking with Deadlock Prevention\nWhen a transaction needs to update inventory, we acquire row-level locks in a consistent order:\nclass InventoryService: def update_quantities(self, items: list[tuple[int, Decimal]]): \"\"\" Update multiple product quantities atomically. Items: list of (product_id, quantity_delta) tuples \"\"\" # Sort by ID to prevent deadlocks sorted_items = sorted(items, key=lambda x: x[0]) with transaction.atomic(): for product_id, delta in sorted_items: # NOWAIT fails immediately if lock unavailable # Better to fail fast than queue indefinitely product = ( Product.objects .select_for_update(nowait=True) .get(id=product_id) ) product.quantity += delta product.save(update_fields=['quantity', 'updated_at']) The nowait=True is critical. Without it, transactions queue up waiting for locks, creating latency spikes during busy periods. With nowait, we fail fast and let the application retry with exponential backoff.\nLayer 2: Optimistic Locking for Frontend Sync\nFor the frontend, we need to detect when data has changed between read and write:\nclass Product(models.Model): version = models.PositiveIntegerField(default=0) def save(self, *args, **kwargs): if self.pk: updated = Product.objects.filter( pk=self.pk, version=self.version ).update( version=self.version + 1, **{f: getattr(self, f) for f in kwargs.get('update_fields', [])} ) if not updated: raise StaleDataError(\"Record modified by another user\") super().save(*args, **kwargs) The frontend polls for version changes with a lightweight endpoint that returns ~50 bytes per product—just IDs and versions. When versions mismatch, the UI shows a conflict resolution dialog rather than silently overwriting.\nFinancial System: Advisory Locks and Double-Entry Bookkeeping Customer balances are the most sensitive data in the system. A miscalculation means either overcharging customers or losing money.\nPostgreSQL Advisory Locks for Balance Operations\nDatabase row locks work for single-row updates, but balance calculations touch multiple rows. We use PostgreSQL advisory locks to serialize operations per customer:\nclass LedgerService: def credit_customer(self, customer_id: int, amount: Decimal, reason: str): # Advisory lock scoped to this customer lock_id = hash(f\"customer_balance_{customer_id}\") \u0026 0x7FFFFFFF with connection.cursor() as cursor: cursor.execute(\"SELECT pg_advisory_lock(%s)\", [lock_id]) try: with transaction.atomic(): entry = LedgerEntry.objects.create( customer_id=customer_id, entry_type=EntryType.CREDIT, amount=amount, reason=reason, running_balance=self._calculate_new_balance(customer_id, amount) ) # Trigger recalculation signals balance_changed.send(sender=self, customer_id=customer_id) return entry finally: with connection.cursor() as cursor: cursor.execute(\"SELECT pg_advisory_unlock(%s)\", [lock_id]) Double-Entry with Automatic Reversals\nEvery financial operation creates a reversible entry. Returns don’t delete the original sale—they create a counter-entry:\nclass LedgerEntry(models.Model): entry_type = models.CharField(choices=EntryType.choices) amount = models.DecimalField(max_digits=12, decimal_places=2) reversal_of = models.ForeignKey('self', null=True, on_delete=models.PROTECT) reversed_by = models.ForeignKey('self', null=True, on_delete=models.PROTECT) def reverse(self, reason: str): \"\"\"Create a reversal entry. Original entry remains for audit.\"\"\" reversal = LedgerEntry.objects.create( customer=self.customer, entry_type=self._inverse_type(), amount=self.amount, reason=f\"Reversal: {reason}\", reversal_of=self ) self.reversed_by = reversal self.save(update_fields=['reversed_by']) return reversal Tolerance-Based Financial Equality\nFloating-point comparisons fail on financial data. We use tolerance-based equality:\nFINANCIAL_TOLERANCE = Decimal('0.01') def balances_equal(a: Decimal, b: Decimal) -\u003e bool: return abs(a - b) \u003c FINANCIAL_TOLERANCE def validate_ledger_balance(customer_id: int): \"\"\"Verify running balance matches sum of entries.\"\"\" entries_sum = LedgerEntry.objects.filter( customer_id=customer_id, reversed_by__isnull=True ).aggregate(total=Sum('signed_amount'))['total'] or Decimal('0') current_balance = Customer.objects.get(id=customer_id).balance if not balances_equal(entries_sum, current_balance): raise LedgerIntegrityError( f\"Balance mismatch: entries={entries_sum}, stored={current_balance}\" ) Multi-Tenant Architecture The system serves multiple retail businesses from a single deployment. Data isolation isn’t optional—it’s existential.\nThread-Local Organization Context\nEvery request establishes an organization context that propagates through the entire call stack:\n_org_context = threading.local() class OrganizationMiddleware: def __call__(self, request): org_id = self._extract_org_id(request) _org_context.organization_id = org_id _org_context.organization = Organization.objects.get(id=org_id) try: response = self.get_response(request) finally: _org_context.organization_id = None _org_context.organization = None return response def get_current_organization(): return getattr(_org_context, 'organization', None) Tenant-Aware QuerySet\nAll models inherit from a base that automatically filters by organization:\nclass TenantAwareQuerySet(models.QuerySet): def get_queryset(self): qs = super().get_queryset() org = get_current_organization() if org: return qs.filter(organization=org) return qs.none() # Fail closed, not open class TenantAwareManager(models.Manager): def get_queryset(self): return TenantAwareQuerySet(self.model, using=self._db) class TenantModel(models.Model): organization = models.ForeignKey(Organization, on_delete=models.CASCADE) objects = TenantAwareManager() all_objects = models.Manager() # Escape hatch for admin/migrations class Meta: abstract = True Every query—Product.objects.all(), Customer.objects.filter(name='X')—automatically includes the organization filter. You can’t forget it because it’s built into the ORM.\nBatch Inventory and FIFO Costing Products arrive in batches at different purchase prices. When calculating cost of goods sold, we use FIFO (First In, First Out):\nclass InventoryBatch(models.Model): product = models.ForeignKey(Product, on_delete=models.CASCADE) purchase = models.ForeignKey(Purchase, on_delete=models.PROTECT) supplier = models.ForeignKey(Supplier, on_delete=models.PROTECT) quantity_received = models.DecimalField(max_digits=10, decimal_places=2) quantity_remaining = models.DecimalField(max_digits=10, decimal_places=2) unit_cost = models.DecimalField(max_digits=10, decimal_places=2) received_at = models.DateTimeField(auto_now_add=True) class Product(TenantModel): @property def current_quantity(self): \"\"\"Computed from batches, not stored.\"\"\" return InventoryBatch.objects.filter( product=self ).aggregate( total=Sum('quantity_remaining') )['total'] or Decimal('0') @property def average_cost(self): \"\"\"Weighted average across remaining batches.\"\"\" batches = InventoryBatch.objects.filter( product=self, quantity_remaining__gt=0 ) total_value = sum(b.quantity_remaining * b.unit_cost for b in batches) total_qty = sum(b.quantity_remaining for b in batches) return total_value / total_qty if total_qty else Decimal('0') When selling, we consume from oldest batches first:\ndef consume_inventory(product_id: int, quantity: Decimal) -\u003e list[tuple[Batch, Decimal]]: \"\"\" FIFO consumption. Returns list of (batch, quantity_consumed) pairs for cost calculation and audit trail. \"\"\" consumed = [] remaining = quantity batches = ( InventoryBatch.objects .filter(product_id=product_id, quantity_remaining__gt=0) .order_by('received_at') .select_for_update() ) for batch in batches: if remaining \u003c= 0: break take = min(batch.quantity_remaining, remaining) batch.quantity_remaining -= take batch.save(update_fields=['quantity_remaining']) consumed.append((batch, take)) remaining -= take if remaining \u003e 0: raise InsufficientInventoryError(f\"Short {remaining} units\") return consumed The PROTECT on supplier prevents orphaned batches—you can’t delete a supplier while inventory from them exists. This maintains the audit trail for traceability.\nSoft Delete with Audit Trail Deleted records aren’t actually deleted—they’re flagged for audit and recovery:\nclass SoftDeleteQuerySet(TenantAwareQuerySet): def get_queryset(self): return super().get_queryset().filter(deleted_at__isnull=True) def with_deleted(self): return super().get_queryset() class AuditModel(TenantModel): created_at = models.DateTimeField(auto_now_add=True) created_by = models.ForeignKey(User, on_delete=models.PROTECT, related_name='+') updated_at = models.DateTimeField(auto_now=True) updated_by = models.ForeignKey(User, on_delete=models.PROTECT, related_name='+') deleted_at = models.DateTimeField(null=True, blank=True) deleted_by = models.ForeignKey(User, null=True, on_delete=models.PROTECT, related_name='+') deletion_reason = models.TextField(blank=True) objects = SoftDeleteManager() all_objects = models.Manager() def soft_delete(self, user, reason: str): self.deleted_at = timezone.now() self.deleted_by = user self.deletion_reason = reason self.save(update_fields=['deleted_at', 'deleted_by', 'deletion_reason']) This combines with tenant-awareness—Product.objects.all() returns non-deleted products for the current organization only.\nFrontend Architecture The Vue 3 frontend separates concerns cleanly between UI state and server state.\nComposables for Everything\nOver 100 composables handle different concerns:\n// useCart.ts - Cart UI state (Pinia) export const useCart = defineStore('cart', () =\u003e { const items = ref\u003cCartItem[]\u003e([]) const customerId = ref\u003cnumber | null\u003e(null) // Persisted to sessionStorage for recovery const persistedState = useSessionStorage('cart-state', { items: [], customerId: null }) // Sync with persisted state watch([items, customerId], () =\u003e { persistedState.value = { items: items.value, customerId: customerId.value } }) return { items, customerId, /* ... */ } }) // useProducts.ts - Server state (TanStack Query) export function useProducts(filters: ProductFilters) { return useQuery({ queryKey: ['products', filters], queryFn: () =\u003e api.products.list(filters), staleTime: 30_000, }) } // useProductVersions.ts - Lightweight polling for conflict detection export function useProductVersions(productIds: number[]) { return useQuery({ queryKey: ['product-versions', productIds], queryFn: () =\u003e api.products.versions(productIds), refetchInterval: 5_000, // 5s polling }) } Cart Recovery\nSession persistence means abandoned carts survive page refreshes:\nexport function useCartRecovery() { const cart = useCart() onMounted(() =\u003e { const persisted = sessionStorage.getItem('cart-state') if (persisted) { const { items, customerId } = JSON.parse(persisted) if (items.length \u003e 0) { showRecoveryDialog({ items, customerId }) } } }) } Real-Time Sync: Hybrid SSE + Polling We use Server-Sent Events for immediate updates with polling as fallback:\nclass RealtimeSync { private eventSource: EventSource | null = null private pollInterval: number | null = null connect() { if (typeof EventSource !== 'undefined') { this.eventSource = new EventSource('/api/events/') this.eventSource.onmessage = this.handleEvent this.eventSource.onerror = this.fallbackToPolling } else { this.fallbackToPolling() } } private fallbackToPolling() { this.eventSource?.close() this.pollInterval = setInterval(() =\u003e this.poll(), 5000) } private handleEvent(event: MessageEvent) { const { type, payload } = JSON.parse(event.data) if (type === 'inventory_update') { queryClient.invalidateQueries({ queryKey: ['products'] }) } else if (type === 'version_conflict') { showConflictDialog(payload) } } } Optimistic UI updates show changes immediately, with server confirmation reconciling any conflicts:\nconst updateQuantity = useMutation({ mutationFn: (data) =\u003e api.inventory.update(data), onMutate: async (data) =\u003e { // Cancel outgoing refetches await queryClient.cancelQueries({ queryKey: ['products', data.productId] }) // Snapshot previous value const previous = queryClient.getQueryData(['products', data.productId]) // Optimistically update queryClient.setQueryData(['products', data.productId], (old) =\u003e ({ ...old, quantity: old.quantity + data.delta })) return { previous } }, onError: (err, data, context) =\u003e { // Rollback on error queryClient.setQueryData(['products', data.productId], context.previous) }, onSettled: () =\u003e { queryClient.invalidateQueries({ queryKey: ['products'] }) } }) Screenshots Dashboard with business insights Product management Checkout with price history Customer balance tracking Sales reporting Generated invoice PDF What I Learned Fail closed, not open. The tenant-aware queryset returns .none() when there’s no organization context rather than returning everything. This default-deny approach catches bugs before they become security incidents.\nComputed vs stored quantities. Storing inventory quantities seems simpler, but computed quantities from batch records eliminate an entire class of drift bugs. The performance cost of aggregation is worth the consistency guarantee.\nAdvisory locks solve coordination problems. Row-level locks work for single-record updates, but cross-record operations need explicit coordination. PostgreSQL advisory locks are underused for application-level synchronization.\nVersion fields catch what transactions miss. Transactions prevent concurrent writes, but they don’t help when a user stares at stale data for 10 minutes before clicking save. Optimistic locking with version fields closes that gap.\nInterested? If you’re looking for similar ERP/POS development or want to discuss the technical details, book a call.\n","wordCount":"1650","inLanguage":"en","datePublished":"2025-02-10T00:00:00Z","dateModified":"2025-02-10T00:00:00Z","author":{"@type":"Person","name":"Muhammad Hassan Raza"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mhassan.dev/projects/polaris/"},"publisher":{"@type":"Organization","name":"Muhammad Hassan Raza","logo":{"@type":"ImageObject","url":"https://mhassan.dev/assets/favicon.svg"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://mhassan.dev/ accesskey=h title="Muhammad Hassan Raza (Alt + H)">Muhammad Hassan Raza</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mhassan.dev/book-a-call/ title="Book a Call"><span><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M8.26 1.289l-1.564.772c-5.793 3.02 2.798 20.944 9.31 20.944.46.0.904-.094 1.317-.284l1.542-.755-2.898-5.594-1.54.754c-.181.087-.384.134-.597.134-2.561.0-6.841-8.204-4.241-9.596l1.546-.763L8.26 1.289zM16.006 24C10.326 24 3.785 12.886 3.785 6.168c0-2.419.833-4.146 2.457-4.992l2.382-1.176 3.857 7.347-2.437 1.201c-1.439.772 2.409 8.424 3.956 7.68l2.399-1.179 3.816 7.36s-2.36 1.162-2.476 1.215c-.547.251-1.129.376-1.733.376"/></svg>Book a Call</span></a></li><li><a href=https://mhassan.dev/projects/ title=Projects><span><svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5h13v17H0V2h8l3 3zM1 3v18h22V6H10.586l-3-3H1z"/></svg>Projects</span></a></li><li><a href=https://mhassan.dev/about/ title=About><span><svg class="menu-icon" shape-rendering="geometricPrecision" viewBox="-1 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 0c6.623.0 12 5.377 12 12s-5.377 12-12 12S0 18.623.0 12 5.377.0 12 0zm8.127 19.41c-.282-.401-.772-.654-1.624-.85-3.848-.906-4.097-1.501-4.352-2.059-.259-.565-.19-1.23.205-1.977 1.726-3.257 2.09-6.024 1.027-7.79C14.709 5.615 13.508 5 12 5c-1.521.0-2.732.626-3.409 1.763-1.066 1.789-.693 4.544 1.049 7.757.402.742.476 1.406.22 1.974-.265.586-.611 1.19-4.365 2.066-.852.196-1.342.449-1.623.848C5.884 21.615 8.782 23 12 23s6.115-1.385 8.127-3.59zm.65-.782C22.172 16.784 23 14.488 23 12c0-6.071-4.929-11-11-11S1 5.929 1 12c0 2.487.827 4.783 2.222 6.626.409-.452 1.049-.81 2.049-1.041 2.025-.462 3.376-.836 3.678-1.502.122-.272.061-.628-.188-1.087-1.917-3.535-2.282-6.641-1.03-8.745C8.584 4.82 10.139 4 12 4c1.845.0 3.391.808 4.24 2.218 1.251 2.079.896 5.195-1 8.774-.245.463-.304.821-.179 1.094.305.668 1.644 1.038 3.667 1.499 1 .23 1.64.59 2.049 1.043z"/></svg>About</span></a></li><li><a href=https://mhassan.dev/search/ title="Search (Alt + /)" accesskey=/><span><svg class="menu-icon" shape-rendering="geometricPrecision" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M15.853 16.56C14.17 18.077 11.942 19 9.5 19 4.257 19 0 14.743.0 9.5S4.257.0 9.5.0 19 4.257 19 9.5c0 2.442-.923 4.67-2.44 6.353l7.44 7.44-.707.707-7.44-7.44zm-6.353-15.56c4.691.0 8.5 3.809 8.5 8.5S14.191 18 9.5 18 1 14.191 1 9.5 4.809 1 9.5 1z"/></svg>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mhassan.dev/>Home</a>&nbsp;»&nbsp;<a href=https://mhassan.dev/projects/>Projects</a></div><h1 class=post-title>Polaris ERP</h1><div class=post-description>Full-stack retail ERP system with race-condition-safe inventory, double-entry bookkeeping, and multi-tenant architecture</div><div class=post-meta><span title='2025-02-10 00:00:00 +0000 UTC'>February 10, 2025</span>&nbsp;·&nbsp;<span>8 min</span>&nbsp;·&nbsp;<span>Muhammad Hassan Raza</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#the-hard-problems aria-label="The Hard Problems">The Hard Problems</a></li><li><a href=#technical-deep-dives aria-label="Technical Deep Dives">Technical Deep Dives</a><ul><li><a href=#race-condition-prevention-dual-layer-locking aria-label="Race Condition Prevention: Dual-Layer Locking">Race Condition Prevention: Dual-Layer Locking</a></li><li><a href=#financial-system-advisory-locks-and-double-entry-bookkeeping aria-label="Financial System: Advisory Locks and Double-Entry Bookkeeping">Financial System: Advisory Locks and Double-Entry Bookkeeping</a></li><li><a href=#multi-tenant-architecture aria-label="Multi-Tenant Architecture">Multi-Tenant Architecture</a></li><li><a href=#batch-inventory-and-fifo-costing aria-label="Batch Inventory and FIFO Costing">Batch Inventory and FIFO Costing</a></li><li><a href=#soft-delete-with-audit-trail aria-label="Soft Delete with Audit Trail">Soft Delete with Audit Trail</a></li><li><a href=#frontend-architecture aria-label="Frontend Architecture">Frontend Architecture</a></li><li><a href=#real-time-sync-hybrid-sse--polling aria-label="Real-Time Sync: Hybrid SSE + Polling">Real-Time Sync: Hybrid SSE + Polling</a></li></ul></li><li><a href=#screenshots aria-label=Screenshots>Screenshots</a></li><li><a href=#what-i-learned aria-label="What I Learned">What I Learned</a></li><li><a href=#interested aria-label=Interested?>Interested?</a></li></ul></div></details></div><div class=post-content><p>Polaris is a full-stack ERP and POS system I built for retail businesses. It handles inventory, sales, customer management, and financial reporting—the kind of system where bugs cost money and downtime loses customers.</p><p><strong>Tech Stack:</strong> Vue 3, Pinia, TanStack Query, Django, Django REST Framework, PostgreSQL, WeasyPrint</p><p><strong>Source:</strong> Private (client work) · <a href=/book-a-call/>Book a call</a> to discuss</p><hr><h2 id=the-hard-problems>The Hard Problems<a hidden class=anchor aria-hidden=true href=#the-hard-problems>#</a></h2><p>Building ERP software sounds straightforward until you hit the edge cases that make or break real businesses:</p><ol><li><p><strong>Concurrent inventory access</strong> — Two cashiers selling the last item at the same time. Two stock clerks adjusting quantities. A sale happening while someone generates a report.</p></li><li><p><strong>Financial integrity</strong> — Customer balances that must always reconcile. Partial payments, returns, credit notes, and adjustments that all need to balance correctly.</p></li><li><p><strong>Multi-tenant data isolation</strong> — Multiple organizations sharing infrastructure where one tenant must never see another&rsquo;s data—not through bugs, not through clever URL manipulation, not through anything.</p></li><li><p><strong>Batch costing</strong> — Products arrive in batches at different prices. When you sell, which cost do you use? FIFO costing with full supplier traceability.</p></li></ol><hr><h2 id=technical-deep-dives>Technical Deep Dives<a hidden class=anchor aria-hidden=true href=#technical-deep-dives>#</a></h2><h3 id=race-condition-prevention-dual-layer-locking>Race Condition Prevention: Dual-Layer Locking<a hidden class=anchor aria-hidden=true href=#race-condition-prevention-dual-layer-locking>#</a></h3><p>The inventory system uses a dual-layer locking strategy to prevent race conditions without sacrificing performance.</p><p><strong>Layer 1: Pessimistic Locking with Deadlock Prevention</strong></p><p>When a transaction needs to update inventory, we acquire row-level locks in a consistent order:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InventoryService</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>update_quantities</span>(self, items: list[tuple[int, Decimal]]):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Update multiple product quantities atomically.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Items: list of (product_id, quantity_delta) tuples
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Sort by ID to prevent deadlocks</span>
</span></span><span style=display:flex><span>        sorted_items <span style=color:#f92672>=</span> sorted(items, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> transaction<span style=color:#f92672>.</span>atomic():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> product_id, delta <span style=color:#f92672>in</span> sorted_items:
</span></span><span style=display:flex><span>                <span style=color:#75715e># NOWAIT fails immediately if lock unavailable</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># Better to fail fast than queue indefinitely</span>
</span></span><span style=display:flex><span>                product <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>                    Product<span style=color:#f92672>.</span>objects
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span>select_for_update(nowait<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span>get(id<span style=color:#f92672>=</span>product_id)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                product<span style=color:#f92672>.</span>quantity <span style=color:#f92672>+=</span> delta
</span></span><span style=display:flex><span>                product<span style=color:#f92672>.</span>save(update_fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;quantity&#39;</span>, <span style=color:#e6db74>&#39;updated_at&#39;</span>])
</span></span></code></pre></div><p>The <code>nowait=True</code> is critical. Without it, transactions queue up waiting for locks, creating latency spikes during busy periods. With <code>nowait</code>, we fail fast and let the application retry with exponential backoff.</p><p><strong>Layer 2: Optimistic Locking for Frontend Sync</strong></p><p>For the frontend, we need to detect when data has changed between read and write:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Product</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    version <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>PositiveIntegerField(default<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>save</span>(self, <span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>pk:
</span></span><span style=display:flex><span>            updated <span style=color:#f92672>=</span> Product<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>                pk<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>pk,
</span></span><span style=display:flex><span>                version<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>version
</span></span><span style=display:flex><span>            )<span style=color:#f92672>.</span>update(
</span></span><span style=display:flex><span>                version<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>version <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>**</span>{f: getattr(self, f) <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> kwargs<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;update_fields&#39;</span>, [])}
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> updated:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> StaleDataError(<span style=color:#e6db74>&#34;Record modified by another user&#34;</span>)
</span></span><span style=display:flex><span>        super()<span style=color:#f92672>.</span>save(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span></code></pre></div><p>The frontend polls for version changes with a lightweight endpoint that returns ~50 bytes per product—just IDs and versions. When versions mismatch, the UI shows a conflict resolution dialog rather than silently overwriting.</p><hr><h3 id=financial-system-advisory-locks-and-double-entry-bookkeeping>Financial System: Advisory Locks and Double-Entry Bookkeeping<a hidden class=anchor aria-hidden=true href=#financial-system-advisory-locks-and-double-entry-bookkeeping>#</a></h3><p>Customer balances are the most sensitive data in the system. A miscalculation means either overcharging customers or losing money.</p><p><strong>PostgreSQL Advisory Locks for Balance Operations</strong></p><p>Database row locks work for single-row updates, but balance calculations touch multiple rows. We use PostgreSQL advisory locks to serialize operations per customer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LedgerService</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>credit_customer</span>(self, customer_id: int, amount: Decimal, reason: str):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Advisory lock scoped to this customer</span>
</span></span><span style=display:flex><span>        lock_id <span style=color:#f92672>=</span> hash(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;customer_balance_</span><span style=color:#e6db74>{</span>customer_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x7FFFFFFF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> connection<span style=color:#f92672>.</span>cursor() <span style=color:#66d9ef>as</span> cursor:
</span></span><span style=display:flex><span>            cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT pg_advisory_lock(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>, [lock_id])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> transaction<span style=color:#f92672>.</span>atomic():
</span></span><span style=display:flex><span>                entry <span style=color:#f92672>=</span> LedgerEntry<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>                    customer_id<span style=color:#f92672>=</span>customer_id,
</span></span><span style=display:flex><span>                    entry_type<span style=color:#f92672>=</span>EntryType<span style=color:#f92672>.</span>CREDIT,
</span></span><span style=display:flex><span>                    amount<span style=color:#f92672>=</span>amount,
</span></span><span style=display:flex><span>                    reason<span style=color:#f92672>=</span>reason,
</span></span><span style=display:flex><span>                    running_balance<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>_calculate_new_balance(customer_id, amount)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                <span style=color:#75715e># Trigger recalculation signals</span>
</span></span><span style=display:flex><span>                balance_changed<span style=color:#f92672>.</span>send(sender<span style=color:#f92672>=</span>self, customer_id<span style=color:#f92672>=</span>customer_id)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> entry
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> connection<span style=color:#f92672>.</span>cursor() <span style=color:#66d9ef>as</span> cursor:
</span></span><span style=display:flex><span>                cursor<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;SELECT pg_advisory_unlock(</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)&#34;</span>, [lock_id])
</span></span></code></pre></div><p><strong>Double-Entry with Automatic Reversals</strong></p><p>Every financial operation creates a reversible entry. Returns don&rsquo;t delete the original sale—they create a counter-entry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LedgerEntry</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    entry_type <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(choices<span style=color:#f92672>=</span>EntryType<span style=color:#f92672>.</span>choices)
</span></span><span style=display:flex><span>    amount <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DecimalField(max_digits<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>, decimal_places<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    reversal_of <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(<span style=color:#e6db74>&#39;self&#39;</span>, null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT)
</span></span><span style=display:flex><span>    reversed_by <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(<span style=color:#e6db74>&#39;self&#39;</span>, null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reverse</span>(self, reason: str):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;Create a reversal entry. Original entry remains for audit.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        reversal <span style=color:#f92672>=</span> LedgerEntry<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>            customer<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>customer,
</span></span><span style=display:flex><span>            entry_type<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>_inverse_type(),
</span></span><span style=display:flex><span>            amount<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>amount,
</span></span><span style=display:flex><span>            reason<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Reversal: </span><span style=color:#e6db74>{</span>reason<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>            reversal_of<span style=color:#f92672>=</span>self
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>reversed_by <span style=color:#f92672>=</span> reversal
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>save(update_fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;reversed_by&#39;</span>])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> reversal
</span></span></code></pre></div><p><strong>Tolerance-Based Financial Equality</strong></p><p>Floating-point comparisons fail on financial data. We use tolerance-based equality:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>FINANCIAL_TOLERANCE <span style=color:#f92672>=</span> Decimal(<span style=color:#e6db74>&#39;0.01&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>balances_equal</span>(a: Decimal, b: Decimal) <span style=color:#f92672>-&gt;</span> bool:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> abs(a <span style=color:#f92672>-</span> b) <span style=color:#f92672>&lt;</span> FINANCIAL_TOLERANCE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>validate_ledger_balance</span>(customer_id: int):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Verify running balance matches sum of entries.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    entries_sum <span style=color:#f92672>=</span> LedgerEntry<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>        customer_id<span style=color:#f92672>=</span>customer_id,
</span></span><span style=display:flex><span>        reversed_by__isnull<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    )<span style=color:#f92672>.</span>aggregate(total<span style=color:#f92672>=</span>Sum(<span style=color:#e6db74>&#39;signed_amount&#39;</span>))[<span style=color:#e6db74>&#39;total&#39;</span>] <span style=color:#f92672>or</span> Decimal(<span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_balance <span style=color:#f92672>=</span> Customer<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(id<span style=color:#f92672>=</span>customer_id)<span style=color:#f92672>.</span>balance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> balances_equal(entries_sum, current_balance):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> LedgerIntegrityError(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Balance mismatch: entries=</span><span style=color:#e6db74>{</span>entries_sum<span style=color:#e6db74>}</span><span style=color:#e6db74>, stored=</span><span style=color:#e6db74>{</span>current_balance<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><hr><h3 id=multi-tenant-architecture>Multi-Tenant Architecture<a hidden class=anchor aria-hidden=true href=#multi-tenant-architecture>#</a></h3><p>The system serves multiple retail businesses from a single deployment. Data isolation isn&rsquo;t optional—it&rsquo;s existential.</p><p><strong>Thread-Local Organization Context</strong></p><p>Every request establishes an organization context that propagates through the entire call stack:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>_org_context <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>local()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrganizationMiddleware</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__call__</span>(self, request):
</span></span><span style=display:flex><span>        org_id <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_extract_org_id(request)
</span></span><span style=display:flex><span>        _org_context<span style=color:#f92672>.</span>organization_id <span style=color:#f92672>=</span> org_id
</span></span><span style=display:flex><span>        _org_context<span style=color:#f92672>.</span>organization <span style=color:#f92672>=</span> Organization<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(id<span style=color:#f92672>=</span>org_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>get_response(request)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>            _org_context<span style=color:#f92672>.</span>organization_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>            _org_context<span style=color:#f92672>.</span>organization <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_current_organization</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getattr(_org_context, <span style=color:#e6db74>&#39;organization&#39;</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></div><p><strong>Tenant-Aware QuerySet</strong></p><p>All models inherit from a base that automatically filters by organization:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TenantAwareQuerySet</span>(models<span style=color:#f92672>.</span>QuerySet):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_queryset</span>(self):
</span></span><span style=display:flex><span>        qs <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>get_queryset()
</span></span><span style=display:flex><span>        org <span style=color:#f92672>=</span> get_current_organization()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> org:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> qs<span style=color:#f92672>.</span>filter(organization<span style=color:#f92672>=</span>org)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> qs<span style=color:#f92672>.</span>none()  <span style=color:#75715e># Fail closed, not open</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TenantAwareManager</span>(models<span style=color:#f92672>.</span>Manager):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_queryset</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> TenantAwareQuerySet(self<span style=color:#f92672>.</span>model, using<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>_db)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TenantModel</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    organization <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(Organization, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>CASCADE)
</span></span><span style=display:flex><span>    objects <span style=color:#f92672>=</span> TenantAwareManager()
</span></span><span style=display:flex><span>    all_objects <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>Manager()  <span style=color:#75715e># Escape hatch for admin/migrations</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        abstract <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>Every query—<code>Product.objects.all()</code>, <code>Customer.objects.filter(name='X')</code>—automatically includes the organization filter. You can&rsquo;t forget it because it&rsquo;s built into the ORM.</p><hr><h3 id=batch-inventory-and-fifo-costing>Batch Inventory and FIFO Costing<a hidden class=anchor aria-hidden=true href=#batch-inventory-and-fifo-costing>#</a></h3><p>Products arrive in batches at different purchase prices. When calculating cost of goods sold, we use FIFO (First In, First Out):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InventoryBatch</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    product <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(Product, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>CASCADE)
</span></span><span style=display:flex><span>    purchase <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(Purchase, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT)
</span></span><span style=display:flex><span>    supplier <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(Supplier, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT)
</span></span><span style=display:flex><span>    quantity_received <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DecimalField(max_digits<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, decimal_places<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    quantity_remaining <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DecimalField(max_digits<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, decimal_places<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    unit_cost <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DecimalField(max_digits<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>, decimal_places<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    received_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField(auto_now_add<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Product</span>(TenantModel):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>current_quantity</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;Computed from batches, not stored.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> InventoryBatch<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>            product<span style=color:#f92672>=</span>self
</span></span><span style=display:flex><span>        )<span style=color:#f92672>.</span>aggregate(
</span></span><span style=display:flex><span>            total<span style=color:#f92672>=</span>Sum(<span style=color:#e6db74>&#39;quantity_remaining&#39;</span>)
</span></span><span style=display:flex><span>        )[<span style=color:#e6db74>&#39;total&#39;</span>] <span style=color:#f92672>or</span> Decimal(<span style=color:#e6db74>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@property</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>average_cost</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;Weighted average across remaining batches.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        batches <span style=color:#f92672>=</span> InventoryBatch<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>            product<span style=color:#f92672>=</span>self,
</span></span><span style=display:flex><span>            quantity_remaining__gt<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        total_value <span style=color:#f92672>=</span> sum(b<span style=color:#f92672>.</span>quantity_remaining <span style=color:#f92672>*</span> b<span style=color:#f92672>.</span>unit_cost <span style=color:#66d9ef>for</span> b <span style=color:#f92672>in</span> batches)
</span></span><span style=display:flex><span>        total_qty <span style=color:#f92672>=</span> sum(b<span style=color:#f92672>.</span>quantity_remaining <span style=color:#66d9ef>for</span> b <span style=color:#f92672>in</span> batches)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> total_value <span style=color:#f92672>/</span> total_qty <span style=color:#66d9ef>if</span> total_qty <span style=color:#66d9ef>else</span> Decimal(<span style=color:#e6db74>&#39;0&#39;</span>)
</span></span></code></pre></div><p>When selling, we consume from oldest batches first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>consume_inventory</span>(product_id: int, quantity: Decimal) <span style=color:#f92672>-&gt;</span> list[tuple[Batch, Decimal]]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FIFO consumption. Returns list of (batch, quantity_consumed) pairs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for cost calculation and audit trail.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    consumed <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    remaining <span style=color:#f92672>=</span> quantity
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    batches <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>        InventoryBatch<span style=color:#f92672>.</span>objects
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>filter(product_id<span style=color:#f92672>=</span>product_id, quantity_remaining__gt<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>order_by(<span style=color:#e6db74>&#39;received_at&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span>select_for_update()
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> batch <span style=color:#f92672>in</span> batches:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> remaining <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        take <span style=color:#f92672>=</span> min(batch<span style=color:#f92672>.</span>quantity_remaining, remaining)
</span></span><span style=display:flex><span>        batch<span style=color:#f92672>.</span>quantity_remaining <span style=color:#f92672>-=</span> take
</span></span><span style=display:flex><span>        batch<span style=color:#f92672>.</span>save(update_fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;quantity_remaining&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        consumed<span style=color:#f92672>.</span>append((batch, take))
</span></span><span style=display:flex><span>        remaining <span style=color:#f92672>-=</span> take
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> remaining <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> InsufficientInventoryError(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Short </span><span style=color:#e6db74>{</span>remaining<span style=color:#e6db74>}</span><span style=color:#e6db74> units&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> consumed
</span></span></code></pre></div><p>The <code>PROTECT</code> on supplier prevents orphaned batches—you can&rsquo;t delete a supplier while inventory from them exists. This maintains the audit trail for traceability.</p><hr><h3 id=soft-delete-with-audit-trail>Soft Delete with Audit Trail<a hidden class=anchor aria-hidden=true href=#soft-delete-with-audit-trail>#</a></h3><p>Deleted records aren&rsquo;t actually deleted—they&rsquo;re flagged for audit and recovery:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SoftDeleteQuerySet</span>(TenantAwareQuerySet):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_queryset</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>get_queryset()<span style=color:#f92672>.</span>filter(deleted_at__isnull<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>with_deleted</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> super()<span style=color:#f92672>.</span>get_queryset()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuditModel</span>(TenantModel):
</span></span><span style=display:flex><span>    created_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField(auto_now_add<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    created_by <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(User, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT, related_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;+&#39;</span>)
</span></span><span style=display:flex><span>    updated_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField(auto_now<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    updated_by <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(User, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT, related_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;+&#39;</span>)
</span></span><span style=display:flex><span>    deleted_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField(null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, blank<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    deleted_by <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(User, null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>PROTECT, related_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;+&#39;</span>)
</span></span><span style=display:flex><span>    deletion_reason <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>TextField(blank<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    objects <span style=color:#f92672>=</span> SoftDeleteManager()
</span></span><span style=display:flex><span>    all_objects <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>Manager()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>soft_delete</span>(self, user, reason: str):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>deleted_at <span style=color:#f92672>=</span> timezone<span style=color:#f92672>.</span>now()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>deleted_by <span style=color:#f92672>=</span> user
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>deletion_reason <span style=color:#f92672>=</span> reason
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>save(update_fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;deleted_at&#39;</span>, <span style=color:#e6db74>&#39;deleted_by&#39;</span>, <span style=color:#e6db74>&#39;deletion_reason&#39;</span>])
</span></span></code></pre></div><p>This combines with tenant-awareness—<code>Product.objects.all()</code> returns non-deleted products for the current organization only.</p><hr><h3 id=frontend-architecture>Frontend Architecture<a hidden class=anchor aria-hidden=true href=#frontend-architecture>#</a></h3><p>The Vue 3 frontend separates concerns cleanly between UI state and server state.</p><p><strong>Composables for Everything</strong></p><p>Over 100 composables handle different concerns:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// useCart.ts - Cart UI state (Pinia)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>useCart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>defineStore</span>(<span style=color:#e6db74>&#39;cart&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>items</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ref</span>&lt;<span style=color:#f92672>CartItem</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt;([])
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>customerId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ref</span>&lt;<span style=color:#f92672>number</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt;(<span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Persisted to sessionStorage for recovery
</span></span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>persistedState</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useSessionStorage</span>(<span style=color:#e6db74>&#39;cart-state&#39;</span>, { <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> [], <span style=color:#a6e22e>customerId</span>: <span style=color:#66d9ef>null</span> })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sync with persisted state
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>watch</span>([<span style=color:#a6e22e>items</span>, <span style=color:#a6e22e>customerId</span>], () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persistedState</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>items.value</span>, <span style=color:#a6e22e>customerId</span>: <span style=color:#66d9ef>customerId.value</span> }
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>items</span>, <span style=color:#a6e22e>customerId</span>, <span style=color:#75715e>/* ... */</span> }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// useProducts.ts - Server state (TanStack Query)
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useProducts</span>(<span style=color:#a6e22e>filters</span>: <span style=color:#66d9ef>ProductFilters</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>useQuery</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;products&#39;</span>, <span style=color:#a6e22e>filters</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryFn</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>products</span>.<span style=color:#a6e22e>list</span>(<span style=color:#a6e22e>filters</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>staleTime</span>: <span style=color:#66d9ef>30_000</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// useProductVersions.ts - Lightweight polling for conflict detection
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useProductVersions</span>(<span style=color:#a6e22e>productIds</span>: <span style=color:#66d9ef>number</span>[]) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>useQuery</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;product-versions&#39;</span>, <span style=color:#a6e22e>productIds</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryFn</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>products</span>.<span style=color:#a6e22e>versions</span>(<span style=color:#a6e22e>productIds</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>refetchInterval</span>: <span style=color:#66d9ef>5_000</span>,  <span style=color:#75715e>// 5s polling
</span></span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Cart Recovery</strong></p><p>Session persistence means abandoned carts survive page refreshes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>useCartRecovery() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useCart</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onMounted</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>persisted</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sessionStorage</span>.<span style=color:#a6e22e>getItem</span>(<span style=color:#e6db74>&#39;cart-state&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>persisted</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>items</span>, <span style=color:#a6e22e>customerId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>persisted</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>showRecoveryDialog</span>({ <span style=color:#a6e22e>items</span>, <span style=color:#a6e22e>customerId</span> })
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=real-time-sync-hybrid-sse--polling>Real-Time Sync: Hybrid SSE + Polling<a hidden class=anchor aria-hidden=true href=#real-time-sync-hybrid-sse--polling>#</a></h3><p>We use Server-Sent Events for immediate updates with polling as fallback:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RealtimeSync</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>eventSource</span>: <span style=color:#66d9ef>EventSource</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>pollInterval</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connect() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>EventSource</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;undefined&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventSource</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>EventSource</span>(<span style=color:#e6db74>&#39;/api/events/&#39;</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventSource</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleEvent</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventSource</span>.<span style=color:#a6e22e>onerror</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>fallbackToPolling</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>fallbackToPolling</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>fallbackToPolling() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventSource</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>close</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pollInterval</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>poll</span>(), <span style=color:#ae81ff>5000</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>handleEvent</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>MessageEvent</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>payload</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;inventory_update&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>invalidateQueries</span>({ <span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;products&#39;</span>] })
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;version_conflict&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>showConflictDialog</span>(<span style=color:#a6e22e>payload</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Optimistic UI updates show changes immediately, with server confirmation reconciling any conflicts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateQuantity</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>useMutation</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutationFn</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>inventory</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>data</span>),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onMutate</span>: <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cancel outgoing refetches
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>cancelQueries</span>({ <span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;products&#39;</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>productId</span>] })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Snapshot previous value
</span></span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>previous</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>getQueryData</span>([<span style=color:#e6db74>&#39;products&#39;</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>productId</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Optimistically update
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>setQueryData</span>([<span style=color:#e6db74>&#39;products&#39;</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>productId</span>], (<span style=color:#a6e22e>old</span>) <span style=color:#f92672>=&gt;</span> ({
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>old</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>quantity</span>: <span style=color:#66d9ef>old.quantity</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>delta</span>
</span></span><span style=display:flex><span>    }))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>previous</span> }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onError</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>context</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rollback on error
</span></span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>setQueryData</span>([<span style=color:#e6db74>&#39;products&#39;</span>, <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>productId</span>], <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>previous</span>)
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onSettled</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>invalidateQueries</span>({ <span style=color:#a6e22e>queryKey</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;products&#39;</span>] })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><hr><h2 id=screenshots>Screenshots<a hidden class=anchor aria-hidden=true href=#screenshots>#</a></h2><section class=screenshots-section><div class=image-grid><figure class=image-card><img src=/assets/home.webp alt="Polaris Dashboard" class=zoomable><figcaption>Dashboard with business insights</figcaption></figure><figure class=image-card><img src=/assets/product-database.webp alt="Product Database" class=zoomable><figcaption>Product management</figcaption></figure><figure class=image-card><img src=/assets/invoice-cart-page.png alt="Cart Page" class=zoomable><figcaption>Checkout with price history</figcaption></figure><figure class=image-card><img src=/assets/customerledger.webp alt="Customer Ledger" class=zoomable><figcaption>Customer balance tracking</figcaption></figure><figure class=image-card><img src=/assets/product-sales-report.webp alt="Sales Report" class=zoomable><figcaption>Sales reporting</figcaption></figure><figure class=image-card><img src=/assets/billpdf.webp alt="Generated Invoice" class=zoomable><figcaption>Generated invoice PDF</figcaption></figure></div></section><hr><h2 id=what-i-learned>What I Learned<a hidden class=anchor aria-hidden=true href=#what-i-learned>#</a></h2><p><strong>Fail closed, not open.</strong> The tenant-aware queryset returns <code>.none()</code> when there&rsquo;s no organization context rather than returning everything. This default-deny approach catches bugs before they become security incidents.</p><p><strong>Computed vs stored quantities.</strong> Storing inventory quantities seems simpler, but computed quantities from batch records eliminate an entire class of drift bugs. The performance cost of aggregation is worth the consistency guarantee.</p><p><strong>Advisory locks solve coordination problems.</strong> Row-level locks work for single-record updates, but cross-record operations need explicit coordination. PostgreSQL advisory locks are underused for application-level synchronization.</p><p><strong>Version fields catch what transactions miss.</strong> Transactions prevent concurrent writes, but they don&rsquo;t help when a user stares at stale data for 10 minutes before clicking save. Optimistic locking with version fields closes that gap.</p><hr><h2 id=interested>Interested?<a hidden class=anchor aria-hidden=true href=#interested>#</a></h2><p>If you&rsquo;re looking for similar ERP/POS development or want to discuss the technical details, <a href=/book-a-call/>book a call</a>.</p><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll(".zoomable");e.forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",function(){window.open(this.src,"_blank")})})})</script></div><footer class=post-footer><ul class=post-tags><li><a href=https://mhassan.dev/tags/django>Django</a></li><li><a href=https://mhassan.dev/tags/vue.js>Vue.js</a></li><li><a href=https://mhassan.dev/tags/postgresql>PostgreSQL</a></li><li><a href=https://mhassan.dev/tags/erp>ERP</a></li><li><a href=https://mhassan.dev/tags/full-stack>Full-Stack</a></li><li><a href=https://mhassan.dev/tags/concurrency>Concurrency</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://mhassan.dev/>Muhammad Hassan Raza</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>(function(){try{if(window.__hasLoggedConsoleBrand)return;var n=getComputedStyle(document.documentElement),e=(n.getPropertyValue("--primary")||"").trim(),t=(n.getPropertyValue("--secondary")||"").trim(),s=e?"hsl("+e+")":"#4f46e5",o=t?"hsl("+t+")":"#facc15",i="color: "+s+"; font-weight: bold; font-family: monospace; font-size: 12px; line-height: 1.2;",a="color: "+o+"; font-weight: bold; font-family: monospace; font-size: 10px;",r=`%c
███████╗ ██████╗ ██████╗     ████████╗██╗  ██╗███████╗
██╔════╝██╔═══██╗██╔══██╗    ╚══██╔══╝██║  ██║██╔════╝
█████╗  ██║   ██║██████╔╝       ██║   ███████║█████╗  
██╔══╝  ██║   ██║██╔══██╗       ██║   ██╔══██║██╔══╝  
██║     ╚██████╔╝██║  ██║       ██║   ██║  ██║███████╗
╚═╝      ╚═════╝ ╚═╝  ╚═╝       ╚═╝   ╚═╝  ╚═╝╚══════╝
                                                        
███████╗███╗   ███╗██████╗ ███████╗██████╗  ██████╗ ██████╗ 
██╔════╝████╗ ████║██╔══██╗██╔════╝██╔══██╗██╔═══██╗██╔══██╗
█████╗  ██╔████╔██║██████╔╝█████╗  ██████╔╝██║   ██║██████╔╝
██╔══╝  ██║╚██╔╝██║██╔═══╝ ██╔══╝  ██╔══██╗██║   ██║██╔══██╗
███████╗██║ ╚═╝ ██║██║     ███████╗██║  ██║╚██████╔╝██║  ██║
╚══════╝╚═╝     ╚═╝╚═╝     ╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═╝
%c
⚔️ In the grim darkness of the dev console, there is only code...`;console.log(r,i,a),window.__hasLoggedConsoleBrand=!0}catch{console.log("⚔️ In the grim darkness of the dev console, there is only code..."),window.__hasLoggedConsoleBrand=!0}})()</script><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>